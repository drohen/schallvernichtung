function z(e){for(var t=e.split(/([#.])/),i="",s="",n=[],o=0;o<t.length;o++){var r=t[o];r==="#"?s=t[++o]:r==="."?n.push(t[++o]):r.length&&(i=r)}return{tag:i||"div",id:s,className:n.join(" ")}}function G(e,t){var i=z(e),s=i.tag,n=i.id,o=i.className,r=t?document.createElementNS(t,s):document.createElement(s);return n&&(r.id=n),o&&(t?r.setAttribute("class",o):r.className=o),r}function E(e,t){var i=p(e),s=p(t);return t===s&&s.__redom_view&&(t=s.__redom_view),s.parentNode&&(C(t,s,i),i.removeChild(s)),t}function C(e,t,i){var s=t.__redom_lifecycle;if(k(s)){t.__redom_lifecycle={};return}var n=i;for(t.__redom_mounted&&y(t,"onunmount");n;){var o=n.__redom_lifecycle||{};for(var r in s)o[r]&&(o[r]-=s[r]);k(o)&&(n.__redom_lifecycle=null),n=n.parentNode}}function k(e){if(e==null)return!0;for(var t in e)if(e[t])return!1;return!0}var H=["onmount","onremount","onunmount"],W=typeof window!="undefined"&&"ShadowRoot"in window;function u(e,t,i,s){var n=p(e),o=p(t);t===o&&o.__redom_view&&(t=o.__redom_view),t!==o&&(o.__redom_view=t);var r=o.__redom_mounted,h=o.parentNode;return r&&h!==n&&C(t,o,h),i!=null?s?n.replaceChild(o,p(i)):n.insertBefore(o,p(i)):n.appendChild(o),J(t,o,n,h),t}function y(e,t){t==="onmount"||t==="onremount"?e.__redom_mounted=!0:t==="onunmount"&&(e.__redom_mounted=!1);var i=e.__redom_lifecycle;if(i){var s=e.__redom_view,n=0;s&&s[t]&&s[t]();for(var o in i)o&&n++;if(n)for(var r=e.firstChild;r;){var h=r.nextSibling;y(r,t),r=h}}}function J(e,t,i,s){for(var n=t.__redom_lifecycle||(t.__redom_lifecycle={}),o=i===s,r=!1,h=0,d=H;h<d.length;h+=1){var l=d[h];o||e!==t&&l in e&&(n[l]=(n[l]||0)+1),n[l]&&(r=!0)}if(!r){t.__redom_lifecycle={};return}var a=i,c=!1;for((o||a&&a.__redom_mounted)&&(y(t,o?"onremount":"onmount"),c=!0);a;){var f=a.parentNode,m=a.__redom_lifecycle||(a.__redom_lifecycle={});for(var g in n)m[g]=(m[g]||0)+n[g];if(c)break;(a.nodeType===Node.DOCUMENT_NODE||W&&a instanceof ShadowRoot||f&&f.__redom_mounted)&&(y(a,o?"onremount":"onmount"),c=!0),a=f}}function K(e,t,i){var s=p(e);if(typeof t=="object")for(var n in t)R(s,n,t[n]);else R(s,t,i)}function R(e,t,i){i==null?e.style[t]="":e.style[t]=i}var B="http://www.w3.org/1999/xlink";function S(e,t,i,s){var n=p(e),o=typeof t=="object";if(o)for(var r in t)S(n,r,t[r],s);else{var h=n instanceof SVGElement,d=typeof i=="function";if(t==="style"&&typeof i=="object")K(n,i);else if(h&&d)n[t]=i;else if(t==="dataset")T(n,i);else if(!h&&(t in n||d)&&t!=="list")n[t]=i;else{if(h&&t==="xlink"){N(n,i);return}s&&t==="class"&&(i=n.className+" "+i),i==null?n.removeAttribute(t):n.setAttribute(t,i)}}}function N(e,t,i){if(typeof t=="object")for(var s in t)N(e,s,t[s]);else i!=null?e.setAttributeNS(B,t,i):e.removeAttributeNS(B,t,i)}function T(e,t,i){if(typeof t=="object")for(var s in t)T(e,s,t[s]);else i!=null?e.dataset[t]=i:delete e.dataset[t]}function Q(e){return document.createTextNode(e??"")}function L(e,t,i){for(var s=0,n=t;s<n.length;s+=1){var o=n[s];if(!(o!==0&&!o)){var r=typeof o;r==="function"?o(e):r==="string"||r==="number"?e.appendChild(Q(o)):x(p(o))?u(e,o):o.length?L(e,o,i):r==="object"&&S(e,o,null,i)}}}function X(e){return typeof e=="string"?w(e):p(e)}function p(e){return e.nodeType&&e||!e.el&&e||p(e.el)}function x(e){return e&&e.nodeType}var D={};function w(e){for(var t=[],i=arguments.length-1;i-- >0;)t[i]=arguments[i+1];var s,n=typeof e;if(n==="string")s=A(e).cloneNode(!1);else if(x(e))s=e.cloneNode(!1);else if(n==="function"){var o=e;s=new(Function.prototype.bind.apply(o,[null].concat(t)))}else throw new Error("At least one argument required");return L(p(s),t,!0),s}var v=w;w.extend=function(e){for(var t=[],i=arguments.length-1;i-- >0;)t[i]=arguments[i+1];var s=A(e);return w.bind.apply(w,[this,s].concat(t))};function A(e){return D[e]||(D[e]=G(e))}function O(e){for(var t=[],i=arguments.length-1;i-- >0;)t[i]=arguments[i+1];for(var s=p(e),n=I(e,t,s.firstChild);n;){var o=n.nextSibling;E(e,n),n=o}}function I(e,t,i){for(var s=i,n=new Array(t.length),o=0;o<t.length;o++)n[o]=t[o]&&p(t[o]);for(var r=0;r<t.length;r++){var h=t[r];if(h){var d=n[r];if(d===s){s=s.nextSibling;continue}if(x(d)){var l=s&&s.nextSibling,a=h.__redom_index!=null,c=a&&l===n[r+1];u(e,h,s,c),c&&(s=l);continue}h.length!=null&&(s=I(e,h,s))}}return s}var P=function(e,t,i){this.View=e,this.initData=i,this.oldLookup={},this.lookup={},this.oldViews=[],this.views=[],t!=null&&(this.key=typeof t=="function"?t:Y(t))};P.prototype.update=function(e,t){for(var i=this,s=i.View,n=i.key,o=i.initData,r=n!=null,h=this.lookup,d={},l=new Array(e.length),a=this.views,c=0;c<e.length;c++){var f=e[c],m=void 0;if(r){var g=n(f);m=h[g]||new s(o,f,c,e),d[g]=m,m.__redom_id=g}else m=a[c]||new s(o,f,c,e);m.update&&m.update(f,c,e,t);var F=p(m.el);F.__redom_view=m,l[c]=m}this.oldViews=a,this.views=l,this.oldLookup=h,this.lookup=d};function Y(e){return function(t){return t[e]}}var _=function(e,t,i,s){this.View=t,this.initData=s,this.views=[],this.pool=new P(t,i,s),this.el=X(e),this.keySet=i!=null};_.prototype.update=function(e,t){e===void 0&&(e=[]);var i=this,s=i.keySet,n=this.views;this.pool.update(e,t);var o=this.pool,r=o.views,h=o.lookup;if(s)for(var d=0;d<n.length;d++){var l=n[d],a=l.__redom_id;h[a]==null&&(l.__redom_index=null,E(this,l))}for(var c=0;c<r.length;c++){var f=r[c];f.__redom_index=c}O(this,r),s&&(this.lookup=h),this.views=r};_.extend=function(e,t,i,s){return _.bind(_,e,t,i,s)};var V;(function(e){e[e.noDevice=0]="noDevice",e[e.requestingDevice=1]="requestingDevice",e[e.idle=2]="idle",e[e.starting=3]="starting",e[e.recording=4]="recording",e[e.closing=5]="closing",e[e.error=6]="error"})(V||(V={}));var Z=class{constructor(e,t){this.handler=e,this.recordLength=t,this.el=v("button","Enable input device"),this.recordBtnEvent=this.recordBtnEvent.bind(this),this.recordBtnDown=this.recordBtnDown.bind(this),this.recordBtnUp=this.recordBtnUp.bind(this),this.stopRecording=this.stopRecording.bind(this),this.setError=this.setError.bind(this),this.setRecordingReady=this.setRecordingReady.bind(this),this.el.addEventListener("click",this.recordBtnEvent),this.state=0,this.mediaTracks=[],this.recordingTimeout=0}reset(){this.error=void 0,this.state=0,this.el.removeEventListener("mousedown",this.recordBtnDown),this.el.removeEventListener("touchstart",this.recordBtnDown),this.el.removeEventListener("mouseup",this.recordBtnUp),this.el.removeEventListener("mouseleave",this.recordBtnUp),this.el.removeEventListener("touchend",this.recordBtnUp),this.handler.reloadContext()}setError(e){this.state=6,this.error=e,this.enable("Reload context"),this.mediaTracks.forEach(t=>t.stop()),this.mediaTracks.length=0,this.handler.onError()}setRecordingReady(){this.state=2,this.enable("Hold down to record")}requestDevice(){navigator.mediaDevices.getUserMedia({audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1},video:!1}).then(e=>(this.mediaTracks.push(...e.getAudioTracks()),this.handler.handleStream(e))).then(this.setRecordingReady).catch(this.setError)}disable(e){this.el.textContent=e,this.el.disabled=!0}enable(e){this.el.textContent=e,this.el.disabled=!1}stopRecording(){clearTimeout(this.recordingTimeout),this.state===4&&(this.state=5,this.disable("Stopping..."),this.handler.stopRecording().then(this.setRecordingReady).catch(this.setError))}recordBtnDown(e){e.preventDefault(),e.stopPropagation(),this.state===2&&(this.state=3,this.disable("Starting..."),this.handler.startRecording().then(()=>{this.enable("Release to stop recording"),this.state=4,this.recordingTimeout=window.setTimeout(this.stopRecording,this.recordLength*1e3)}).catch(this.setError))}recordBtnUp(e){e.preventDefault(),e.stopPropagation(),this.stopRecording()}recordBtnEvent(){switch(this.state){case 0:this.state=1,this.disable("Loading..."),this.requestDevice(),this.el.addEventListener("mousedown",this.recordBtnDown),this.el.addEventListener("touchstart",this.recordBtnDown),this.el.addEventListener("mouseup",this.recordBtnUp),this.el.addEventListener("mouseleave",this.recordBtnUp),this.el.addEventListener("touchend",this.recordBtnUp);break;case 6:this.reset();break}}getError(){return this.error}},M;(function(e){e[e.preparing=0]="preparing",e[e.recording=1]="recording",e[e.idle=2]="idle"})(M||(M={}));var ee=class{constructor(e,t,i,s){this.sampleRate=e,this.maxLength=t,this.chunkSize=i,this.handler=s,this.state=2,this.bufferSize=this.sampleRate*this.maxLength,this.recordingLength=0,this.buffer=new Float32Array(this.bufferSize),this.onChunk=this.onChunk.bind(this),this.prepCounter=0}record(){this.isRecording()||(this.recordingLength=0,this.state=1)}onChunk(e){if(this.state===0){this.prepCounter>10?(this.state=1,this.prepCounter=0):this.prepCounter+=1;return}e[0]===0&&e[1]===0&&e[2]===0||(this.buffer.set(e,this.recordingLength),this.recordingLength+=e.length)}stopRecord(){!this.isRecording()||(this.state=2,this.recordingLength-=this.chunkSize,this.handler.onRecorded(this.buffer.subarray(0,this.recordingLength)))}isRecording(){return this.state===1||this.state===0}},U;(function(e){e[e.notStarted=0]="notStarted",e[e.paused=1]="paused",e[e.playing=2]="playing"})(U||(U={}));var te=class{constructor(e,t){this.core=e,this.channels=t,this.samples=[]}joinEnds(e){let t=~~(this.core.context.sampleRate*.05);for(let i=0;i<t;i++)e[i]=e[i]*i/t,e[e.length-1-i]=e[e.length-1-i]*i/t}create(e){this.joinEnds(e);let t=this.core.context.createBuffer(this.channels,e.length,this.core.context.sampleRate),i=this.core.context.createBufferSource();t.copyToChannel(e,0),i.buffer=t,i.loop=!0;let s=this.samples.length;this.samples.push({label:`Sample ${new Date().toUTCString()}`,node:i,state:0}),this.core.onSampleAdd(s)}play(e){if(this.samples[e].state===2)return;let t=this.samples[e].state===0;this.samples[e].state=2,t&&this.samples[e].node.start()}pause(e){this.samples[e].state!==1&&(this.samples[e].state=1)}setLabel(e,t){this.samples[e].label=t,this.core.onLabelChange(e)}setPlaybackSpeed(e,t){this.samples[e].node.playbackRate.linearRampToValueAtTime(t,this.core.context.currentTime+10)}node(e){return this.samples[e].node}label(e){return this.samples[e].label}},ie=class{constructor(e){this.handler=e,this.el=v("div.sampleSelect"),this.handleClick=this.handleClick.bind(this),this.elements=[],this.selectedIndex=-1}handleClick(e){e!==this.selectedIndex&&(this.selectedIndex>-1&&this.elements[this.selectedIndex].classList.remove("selected"),this.elements[e].classList.add("selected"),this.handler.onSampleSelected(e,this.selectedIndex>-1?this.selectedIndex:void 0),this.selectedIndex=e)}add(e,t){let i=v("div.sampleItem",t);i.addEventListener("click",s=>{s.preventDefault(),this.handleClick(e)}),this.elements.push(i),u(this.el,i)}},se=class{constructor(e,t,i){this.id=e,this.inputNode=t,this.outputNode=i,this.isExt=!0}isExtension(e){return"isExt"in e&&e.isExt}setInput(e){if(this.inputNode)throw Error(`Input node already set for ${this.id}`);this.inputNode=e}setOutput(e){if(this.outputNode)throw Error(`Output node already set for ${this.id}`);this.outputNode=e}input(){if(!this.inputNode)throw Error(`No input node set for ${this.id}`);return this.inputNode}output(){if(!this.outputNode)throw Error(`No output node set for ${this.id}`);return this.outputNode}connectInput(e){this.isExtension(e)?e.output().connect(this.input()):e.connect(this.input())}disconnectInput(e){this.isExtension(e)?e.output().disconnect(this.input()):e.disconnect(this.input())}connectOutput(e){this.isExtension(e)?this.output().connect(e.input()):this.output().connect(e)}disconnectOutput(e){this.isExtension(e)?this.output().disconnect(e.input()):this.output().disconnect(e)}},b=class extends se{constructor(e,t,i="min"){super(e);this.core=t;let s=typeof i=="number"?i:i==="max"?101:i==="mid"?51:1;this.el=v("input",{type:"range",value:s,min:1,max:101,step:1e-4}),this.debounceOnChange=this.debounceOnChange.bind(this),this.el.addEventListener("input",this.debounceOnChange),this.debounce=0,this.debounceCount=0}logRange(e,t,i,s){if(i<=t)return t;let n=1,o=101,r=t<0&&i<0,h=r?t*-1+1:t<=0?-1*t+1:t+1,d=r?i*-1+1:t<=0?i+h:i+1,l=Math.log(h),a=(Math.log(d)-l)/(o-n);return s?(Math.log(e/(r?-1:1)+(r||t>0?1:h))-l)/a+n:(Math.exp(l+a*(e-n))-(r||t>0?1:h))*(r?-1:1)}debounceOnChange(){this.debounceCount+=1,clearTimeout(this.debounce),this.debounceCount>=50&&(this.debounceCount=0,this.onChange(parseFloat(this.el.value))),this.debounce=window.setTimeout(()=>this.onChange(parseFloat(this.el.value)),30)}onChange(e){throw Error(`Override on change, output value is ${e}`)}ramp(e,t){e.linearRampToValueAtTime(t,this.core.context.currentTime+.5)}},ne=class extends b{constructor(e){super("Compressor",e);this.gain=this.core.context.createGain(),this.node=this.core.context.createDynamicsCompressor(),this.gain.connect(this.node),this.setInput(this.gain),this.setOutput(this.node),this.gain.gain.setValueAtTime(-1,this.core.context.currentTime),this.node.threshold.setValueAtTime(-10,this.core.context.currentTime),this.node.knee.setValueAtTime(4,this.core.context.currentTime),this.node.ratio.setValueAtTime(2,this.core.context.currentTime),this.node.attack.setValueAtTime(0,this.core.context.currentTime),this.node.release.setValueAtTime(.1,this.core.context.currentTime)}onChange(e){this.ramp(this.gain.gain,this.logRange(e,-1,-1)),this.ramp(this.node.threshold,0-this.logRange(e,10,100)),this.ramp(this.node.knee,this.logRange(e,4,40)),this.ramp(this.node.ratio,this.logRange(e,2,20)),this.ramp(this.node.release,Math.pow(20,-1*this.logRange(e,1,1e3)))}},oe=class extends b{constructor(e){super("Distortion",e);this.node=this.core.context.createWaveShaper(),this.setInput(this.node),this.setOutput(this.node),this.node.oversample="4x",this.curveData=new Float32Array(this.core.context.sampleRate),this.curve(0),this.node.curve=this.curveData}curve(e){let t=typeof e=="number"?e:50,i=Math.PI/180,s=0;for(let n=0;n<this.core.context.sampleRate;++n)s=n*2/this.core.context.sampleRate-1,this.curveData[n]=(10+t)*s*50*i/(Math.PI+t*Math.abs(s))}onChange(e){this.curve(~~this.logRange(e,0,1e4)),this.node.curve=this.curveData}},re=class extends b{constructor(e){super("Lowpass",e);this.node=this.core.context.createBiquadFilter(),this.setInput(this.node),this.setOutput(this.node),this.node.frequency.value=6e3,this.node.type="lowpass"}onChange(e){this.ramp(this.node.frequency,6e3-this.logRange(e,0,5950*.005)*200)}},$;(function(e){e[e.playing=0]="playing",e[e.paused=1]="paused"})($||($={}));var he=class{constructor(e){this.handler=e,this.el=v("button","Play audio"),this.state=1,this.playBtnEvent=this.playBtnEvent.bind(this),this.el.addEventListener("click",this.playBtnEvent)}playBtnEvent(){switch(this.state){case 1:this.state=0,this.el.textContent="Pause audio",this.handler.onPlay();break;case 0:this.pause();break}}pause(){this.state!==1&&(this.state=1,this.el.textContent="Play audio",this.handler.onPause())}},ae=class extends b{constructor(e,t){super("Speed",e);this.node=t,this.setInput(this.node),this.setOutput(this.node),this.el.value=`${this.logRange(1,.1,3,!0)}`}onChange(e){this.ramp(this.node.playbackRate,this.logRange(e,.1,3))}},ce=class extends b{constructor(e){super("Volume",e,"mid");this.node=this.core.context.createGain(),this.setInput(this.node),this.setOutput(this.node),this.node.gain.setValueAtTime(this.logRange(51,0,3),this.core.context.currentTime)}onChange(e){this.ramp(this.node.gain,this.logRange(e,0,3))}},j;(function(e){e[e.visible=0]="visible",e[e.hidden=1]="hidden"})(j||(j={}));var le=class{constructor(e,t,i){this.core=e,this.bufferNode=t,this.nodeIndex=i,this.el=v("div.hidden"),this.playBtn=new he(this),this.volumeCtrl=new ce(this.core),this.volumeCtrl.connectOutput(this.core.context.destination),this.lowpassCtrl=new re(this.core),this.lowpassCtrl.connectOutput(this.volumeCtrl),this.distortionCtrl=new oe(this.core),this.distortionCtrl.connectOutput(this.lowpassCtrl),this.compressorCtrl=new ne(this.core),this.compressorCtrl.connectOutput(this.distortionCtrl),this.speedCtrl=new ae(this.core,this.bufferNode),u(this.el,this.wrap(this.playBtn)),u(this.el,this.wrap(this.compressorCtrl,"Slide to control compressor")),u(this.el,this.wrap(this.distortionCtrl,"Slide to control distortion")),u(this.el,this.wrap(this.lowpassCtrl,"Slide to control filter")),u(this.el,this.wrap(this.volumeCtrl,"Slide to control volume")),u(this.el,this.wrap(this.speedCtrl,"Slide to control speed")),this.state=1}wrap(e,t){let i=v("div");if(t){let s=v("p",t);u(i,s)}return u(i,e),i}show(){this.state!==0&&(this.state=0,this.el.classList.remove("hidden"))}hide(){this.state!==1&&(this.state=1,this.el.classList.add("hidden"))}async onPlay(){this.compressorCtrl.connectInput(this.bufferNode),this.core.onPlaySample(this.nodeIndex)}async onPause(){this.compressorCtrl.disconnectInput(this.bufferNode),this.core.onPauseSample(this.nodeIndex)}},q=class{static init(){new q}constructor(){this.baseEl=this.getElOrThrow("#root");let e=window.AudioContext||window.webkitAudioContext;this.context=new e,this.context.suspend();let t=10,i=4096;this.recordBtn=new Z(this,t),this.recordBuff=new ee(this.context.sampleRate,t,i,this),this.processorNode=this.context.createScriptProcessor(i,1,1),this.processChunk=this.processChunk.bind(this),this.processorNode.addEventListener("audioprocess",this.processChunk),this.sampleBank=new te(this,1),this.sampleBlocks=[],this.samplesMount=v("div.samplesMount"),this.sampleList=new ie(this),this.setUI()}getElOrThrow(e){let t=document.querySelector(e);if(!t)throw Error(`Couldn't find element ${e}`);return t}wrap(e,t,i){let s=v(`div${i?`.${i}`:""}`);if(t){let n=v("p",t);u(s,n)}return Array.isArray(e)?O(s,e):u(s,e),s}setUI(){u(this.baseEl,this.wrap([this.wrap(this.recordBtn),this.samplesMount],void 0,"controls")),u(this.baseEl,this.sampleList)}processChunk(e){this.recordBuff.isRecording()&&this.recordBuff.onChunk(e.inputBuffer.getChannelData(0))}onRecorded(e){this.sampleBank.create(e)}async handleStream(e){this.context.resume(),this.sourceNode=this.context.createMediaStreamSource(e)}onError(){this.context.suspend(),console.error(this.recordBtn.getError())}async startRecording(){this.sourceNode?.connect(this.processorNode),this.processorNode.connect(this.context.destination),this.recordBuff.record()}async stopRecording(){this.recordBuff.stopRecord(),this.processorNode.disconnect(this.context.destination),this.sourceNode?.disconnect(this.processorNode)}async reloadContext(){this.context.resume()}async onPlaySample(e){this.sampleBank.play(e)}async onPauseSample(e){this.sampleBank.pause(e)}onSampleAdd(e){let t=new le(this,this.sampleBank.node(e),e);this.sampleBlocks.push(t),u(this.samplesMount,t),this.sampleList.add(e,this.sampleBank.label(e))}onLabelChange(){}onSampleSelected(e,t){t!==void 0&&this.sampleBlocks[t].hide(),this.sampleBlocks[e].show()}};q.init();
